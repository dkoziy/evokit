containers:
    frontend:
      environ:
        NODE_PATH: /usr/lib/node_modules
        PROJECT_DEPS: /usr/lib
      setup:
      - !UbuntuRelease { codename: trusty }
      - !Install [ca-certificates, apt-transport-https]
      - !AptTrust
        keys: [1655A0AB68576280]
      - !UbuntuRepo
        url: https://deb.nodesource.com/node_6.x
        suite: trusty
        components: [main]
      - !Install [nodejs]
      - !NpmConfig
        install-node: false
      - !NpmDependencies
        package: true
        dev: true
        optional: true
      - !EnsureDir /root/.npm

commands:
  build_es6: !Command
    description: Run build
    container: frontend
    options: |
      Usage:
        vagga build_es6 [--watch|-w]

      Options:
        --watch, -w          enable webpack watch
    run: |
      webpack --progress ${VAGGACLI_WATCH} --config webpack.es6.config.js

  build: !Command
    description: Run build
    container: frontend
    environ:
      NODE_ENV: production
    run: |
      gulp compile_uikit

  watch: !Command
    description: Run watch *.md
    container: frontend
    run: |
      gulp watch

  publish: !Command
    prerequisites: [build_es6]
    description: Publishes new package version
    container: frontend
    volumes:
      /root/.npm: !Tmpfs
        size: 10Mi
    run: |
      touch /work/.npmrc
      echo "//registry.npmjs.org/:_authToken=$NPM_TOKEN" > /work/.npmrc
      npm publish --access public
